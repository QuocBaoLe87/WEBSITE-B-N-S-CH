<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title th:text="${product.id == null ? 'Thêm sách mới' : 'Chỉnh sửa sách'}">
      Quản lý sách
    </title>

    <!-- Google Font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap"
      rel="stylesheet"
    />
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- FontAwesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css"
      rel="stylesheet"
    />

    <style>
      /* ===== CSS Variables - Bookstore Theme ===== */
      :root {
        --primary-color: #8b6f47;
        --primary-dark: #6b5535;
        --primary-light: #d4a574;
        --accent-color: #d4a574;
        --text-light: #fff8f0;
        --text-muted: #9b8b7e;
        --warm-bg: #faf8f3;
        --border: #e5d5c0;
        --shadow: 0 10px 15px -3px rgba(139, 111, 71, 0.15);
        --transition: all 0.3s ease;
      }

      body {
        font-family: "Poppins", sans-serif;
        background: linear-gradient(
          135deg,
          var(--warm-bg) 0%,
          #ffffff 50%,
          rgba(218, 165, 32, 0.03) 100%
        );
        color: #333;
        padding-top: 72px;
      }

      /* Navbar */
      .navbar {
        background: linear-gradient(
          90deg,
          var(--primary-color),
          var(--primary-dark)
        ) !important;
        box-shadow: var(--shadow);
        border-bottom: 2px solid rgba(218, 165, 32, 0.2);
      }

      .navbar-brand {
        font-weight: 700;
        letter-spacing: 1px;
        color: #fff !important;
        font-size: 1.3rem;
      }

      .navbar-brand i {
        color: #ffc107;
        margin-right: 8px;
      }

      .navbar .btn-outline-light {
        border-color: rgba(255, 255, 255, 0.6);
        color: #fff;
        transition: var(--transition);
      }

      .navbar .btn-outline-light:hover {
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
      }

      /* Card */
      .card {
        border: 1px solid var(--border);
        border-radius: 1.5rem;
        box-shadow: var(--shadow);
        transition: var(--transition);
        background: #fff;
      }

      .card:hover {
        box-shadow: 0 20px 25px -5px rgba(139, 111, 71, 0.2);
        transform: translateY(-2px);
      }

      .card-header {
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--primary-dark)
        );
        color: white;
        font-weight: 600;
        border-radius: 1.5rem 1.5rem 0 0;
        border: none;
      }

      .card-header h5 {
        color: white;
      }

      /* Forms */
      .form-control,
      .form-select {
        border: 2px solid var(--border);
        border-radius: 0.75rem;
        padding: 0.75rem 1rem;
        transition: var(--transition);
        font-size: 0.95rem;
      }

      .form-control:focus,
      .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(139, 111, 71, 0.1);
      }

      .form-floating > label {
        color: var(--text-muted);
      }

      .form-label {
        font-weight: 600;
        color: var(--primary-dark);
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .form-label i {
        color: var(--primary-color);
      }

      /* Buttons */
      .btn {
        padding: 0.625rem 1.25rem;
        border-radius: 0.75rem;
        font-weight: 600;
        transition: var(--transition);
        border: none;
      }

      .btn:active {
        transform: scale(0.95);
      }

      .btn-primary {
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--primary-dark)
        );
        color: white;
      }

      .btn-primary:hover {
        background: linear-gradient(
          135deg,
          var(--primary-dark),
          var(--primary-color)
        );
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(139, 111, 71, 0.3);
      }

      .btn-secondary {
        background: var(--text-muted);
        color: white;
      }

      .btn-outline-secondary:hover {
        background: var(--text-muted);
        color: white;
        transform: translateY(-2px);
      }

      .btn-outline-light {
        border-color: var(--border);
        color: var(--primary-color);
      }

      .btn-outline-light:hover {
        background: var(--primary-color);
        color: white;
        transform: translateY(-2px);
      }

      /* Images */
      .img-preview {
        width: 100%;
        height: 150px;
        margin-top: 0.75rem;
        border-radius: 1rem;
        object-fit: cover;
        border: 2px solid var(--border);
        background: white;
        padding: 0.25rem;
        transition: var(--transition);
        box-shadow: 0 4px 6px -1px rgba(139, 111, 71, 0.1);
      }

      .img-preview:hover {
        transform: scale(1.05);
        border-color: var(--primary-light);
        box-shadow: 0 8px 12px rgba(139, 111, 71, 0.2);
      }

      /* Configuration Panel */
      .cfg-panel {
        border: 2px solid var(--border);
        border-radius: 1rem;
        transition: var(--transition);
        background: white;
      }

      .cfg-panel:hover {
        border-color: var(--primary-light);
      }

      .cfg-header {
        background: linear-gradient(
          135deg,
          rgba(139, 111, 71, 0.05),
          rgba(212, 165, 116, 0.05)
        );
        padding: 1rem;
        border-radius: 1rem 1rem 0 0;
        font-weight: 600;
        color: var(--primary-dark);
        cursor: pointer;
        transition: var(--transition);
      }

      .cfg-header:hover {
        background: linear-gradient(
          135deg,
          rgba(139, 111, 71, 0.1),
          rgba(212, 165, 116, 0.1)
        );
      }

      .cfg-header i {
        color: var(--primary-color);
      }

      /* Upload Zone */
      .upload-zone {
        border: 2px dashed var(--border);
        border-radius: 1rem;
        padding: 1.5rem;
        text-align: center;
        transition: var(--transition);
        background: rgba(212, 165, 116, 0.03);
      }

      .upload-zone:hover {
        border-color: var(--primary-light);
        background: rgba(212, 165, 116, 0.08);
      }

      .upload-zone i {
        color: var(--primary-color);
      }

      .upload-zone label {
        cursor: pointer;
        color: var(--primary-dark);
        font-weight: 500;
      }

      /* Alerts */
      .alert {
        border: none;
        border-radius: 1rem;
        box-shadow: 0 4px 6px -1px rgba(139, 111, 71, 0.1);
      }

      .alert-success {
        background: #ecfdf5;
        color: #059669;
        border-left: 4px solid #10b981;
      }

      .alert-danger {
        background: #fee2e2;
        color: #dc2626;
        border-left: 4px solid #ef4444;
      }

      .alert-info {
        background: rgba(212, 165, 116, 0.1);
        color: var(--primary-dark);
        border-left: 4px solid var(--primary-color);
      }

      /* Breadcrumb */
      .breadcrumb {
        background: transparent;
        padding: 0;
        margin-bottom: 1rem;
      }

      .breadcrumb-item.active {
        color: var(--primary-color);
        font-weight: 600;
      }

      .breadcrumb-item a {
        color: var(--primary-color);
        text-decoration: none;
        transition: var(--transition);
      }

      .breadcrumb-item a:hover {
        color: var(--primary-dark);
      }

      /* Section Cards */
      .card.bg-light {
        background: linear-gradient(
          135deg,
          #ffffff,
          rgba(212, 165, 116, 0.03)
        ) !important;
        border-color: var(--border);
      }

      .card-header.bg-transparent {
        border-bottom: 2px solid var(--border);
        background: transparent !important;
      }

      .card-header.bg-transparent h6 {
        color: var(--primary-dark);
        font-weight: 700;
      }

      .card-header.bg-transparent i {
        color: var(--primary-color);
      }

      /* Featured Flag */
      .badge.bg-info {
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--primary-dark)
        ) !important;
        color: white;
      }

      /* Form Check */
      .form-check-input:checked {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
      }

      /* Animations */
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .card {
        animation: slideIn 0.3s ease;
      }

      /* Progress Bar */
      .progress {
        background: var(--border);
        border-radius: 1rem;
      }

      .progress-bar {
        background: linear-gradient(
          90deg,
          var(--primary-color),
          var(--primary-dark)
        ) !important;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .container {
          padding: 0.5rem;
        }

        .card {
          border-radius: 1rem;
        }

        .btn {
          width: 100%;
          margin-bottom: 0.5rem;
        }

        .img-preview {
          height: 120px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark mb-4 fixed-top">
      <div class="container">
        <a
          class="navbar-brand d-flex align-items-center"
          th:href="@{/admin/dashboard}"
        >
          ADMIN
        </a>
        <div class="ms-auto d-flex align-items-center gap-2">
          <a class="btn btn-outline-light" th:href="@{/}" title="Trang chủ">
            <i class="fas fa-home"></i>
          </a>
          <form th:action="@{/logout}" method="post" class="d-inline">
            <input
              type="hidden"
              th:name="${_csrf.parameterName}"
              th:value="${_csrf.token}"
            />
            <button
              type="submit"
              class="btn btn-outline-light"
              title="Đăng xuất"
            >
              <i class="fas fa-sign-out-alt"></i>
            </button>
          </form>
        </div>
      </div>
    </nav>

    <div class="container py-4">
      <!-- Breadcrumb -->
      <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
            <a th:href="@{/admin/dashboard}" class="text-decoration-none">
              <i class="fas fa-home"></i>
              <span class="ms-1">Trang chủ</span>
            </a>
          </li>
          <li class="breadcrumb-item">
            <a th:href="@{/admin/products}" class="text-decoration-none"
              >Sách</a
            >
          </li>
          <li
            class="breadcrumb-item active"
            aria-current="page"
            th:text="${product.id == null ? 'Thêm mới' : 'Chỉnh sửa'}"
          >
            Form
          </li>
        </ol>
      </nav>

      <div class="card mx-auto" style="max-width: 820px">
        <div
          class="card-header d-flex justify-content-between align-items-center"
        >
          <div class="d-flex align-items-center">
            <div
              class="rounded-circle bg-light p-3 me-3"
              style="background: rgba(255, 255, 255, 0.2) !important"
            >
              <i
                class="fas fa-book"
                style="color: #ffc107; font-size: 1.5rem"
              ></i>
            </div>
            <h5
              class="mb-0"
              th:text="${product.id == null ? 'Thêm sách mới' : 'Chỉnh sửa sách'}"
            >
              Form sản phẩm
            </h5>
          </div>
          <a th:href="@{/admin/products}" class="btn btn-outline-light btn-sm">
            <i class="fas fa-times me-1"></i>
            Đóng
          </a>
        </div>

        <div class="card-body">
          <!-- Progress Bar -->
          <div class="progress mb-4" style="height: 4px">
            <div
              class="progress-bar bg-primary"
              role="progressbar"
              style="width: 0%"
              id="formProgress"
            ></div>
          </div>

          <!-- FLASH MESSAGES -->
          <div
            th:if="${success}"
            class="alert alert-success alert-dismissible fade show mb-4"
            role="alert"
          >
            <div class="d-flex">
              <div class="me-3">
                <i class="fas fa-check-circle fa-2x"></i>
              </div>
              <div>
                <h6 class="alert-heading mb-1">Thành công!</h6>
                <span th:text="${success}">Thao tác thành công</span>
              </div>
            </div>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="alert"
              aria-label="Close"
            ></button>
          </div>

          <div
            th:if="${error}"
            class="alert alert-danger alert-dismissible fade show mb-4"
            role="alert"
          >
            <div class="d-flex">
              <div class="me-3">
                <i class="fas fa-exclamation-triangle fa-2x"></i>
              </div>
              <div>
                <h6 class="alert-heading mb-1">Đã xảy ra lỗi!</h6>
                <span th:text="${error}">Chi tiết lỗi</span>
              </div>
            </div>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="alert"
              aria-label="Close"
            ></button>
          </div>
          <!-- /FLASH MESSAGES -->

          <form
            th:action="@{/admin/product/save}"
            th:object="${product}"
            method="post"
            enctype="multipart/form-data"
            onsubmit="return confirm('Bạn có chắc chắn muốn lưu sản phẩm này không?');"
          >
            <!-- CSRF -->
            <input
              type="hidden"
              th:name="${_csrf.parameterName}"
              th:value="${_csrf.token}"
            />

            <!-- Nếu edit, gửi kèm ID -->
            <input
              type="hidden"
              th:if="${product.id != null}"
              th:field="*{id}"
            />

            <!-- Thông tin cơ bản -->
            <div class="card bg-light border mb-4">
              <div class="card-header bg-transparent border-bottom">
                <h6 class="mb-0">
                  <i class="fas fa-book me-2"></i>
                  Thông tin cơ bản
                </h6>
              </div>
              <div class="card-body">
                <div class="row g-4">
                  <div class="col-md-6">
                    <div class="form-floating mb-3">
                      <input
                        type="text"
                        class="form-control"
                        th:field="*{name}"
                        placeholder="Nhập tên sách"
                        required
                        id="productName"
                      />
                      <label for="productName">
                        <i class="fas fa-book me-2"></i>
                        Tên sách
                      </label>
                      <div
                        th:if="${#fields.hasErrors('name')}"
                        class="invalid-feedback d-block mt-1"
                        th:errors="*{name}"
                      ></div>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="brandName" class="form-label">
                        <i class="fas fa-user-edit me-2"></i>
                        Tác giả
                      </label>
                      <select
                        class="form-select"
                        th:field="*{brand}"
                        id="brandName"
                        required
                      >
                        <option value="">-- Chọn tác giả --</option>
                        <option
                          th:each="brandObj : ${brands}"
                          th:value="${brandObj.name}"
                          th:text="${brandObj.name}"
                        >
                          Author
                        </option>
                      </select>
                      <div
                        th:if="${#fields.hasErrors('brand')}"
                        class="invalid-feedback d-block mt-1"
                        th:errors="*{brand}"
                      ></div>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="form-floating mb-3">
                      <input
                        type="number"
                        step="0.01"
                        min="0"
                        class="form-control"
                        th:field="*{price}"
                        placeholder="Nhập giá"
                        required
                        id="productPrice"
                      />
                      <label for="productPrice">
                        <i class="fas fa-tag me-2"></i>
                        Giá bán
                      </label>
                      <div
                        th:if="${#fields.hasErrors('price')}"
                        class="invalid-feedback d-block mt-1"
                        th:errors="*{price}"
                      ></div>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="form-floating mb-3">
                      <input
                        type="number"
                        min="0"
                        class="form-control"
                        th:field="*{quantity}"
                        placeholder="Nhập tồn kho"
                        required
                        id="productQuantity"
                      />
                      <label for="productQuantity">
                        <i class="fas fa-boxes me-2"></i>
                        Số lượng tồn
                      </label>
                      <div
                        th:if="${#fields.hasErrors('quantity')}"
                        class="invalid-feedback d-block mt-1"
                        th:errors="*{quantity}"
                      ></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Phân loại sách -->
            <div class="card bg-light border mb-4">
              <div class="card-header bg-transparent border-bottom">
                <h6 class="mb-0">
                  <i class="fas fa-list me-2"></i>
                  Phân loại sách
                </h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-floating mb-3">
                      <select
                        id="category"
                        class="form-select"
                        th:field="*{category.id}"
                        required
                      >
                        <option value="">-- Chọn danh mục --</option>
                        <!-- Hiển thị danh mục từ database -->
                        <th:block th:each="c : ${categories}">
                          <option
                            th:value="${c.id}"
                            th:text="${c.name}"
                          ></option>
                        </th:block>
                      </select>
                      <label for="category">
                        <i class="fas fa-folder me-2"></i>
                        Danh mục sách
                      </label>
                      <div
                        th:if="${#fields.hasErrors('category')}"
                        class="invalid-feedback d-block mt-1"
                        th:errors="*{category}"
                      ></div>
                      <div
                        th:if="${#fields.hasErrors('category.id')}"
                        class="invalid-feedback d-block mt-1"
                        th:errors="*{category.id}"
                      ></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Cấu hình sách -->
            <div class="card bg-light border mb-4">
              <div class="card-header bg-transparent border-bottom">
                <h6 class="mb-0">
                  <i class="fas fa-list me-2"></i>
                  Mô tả sách
                </h6>
              </div>
              <div class="card-body">
                <div class="form-floating mb-3">
                  <textarea
                    class="form-control"
                    th:field="*{configuration}"
                    rows="2"
                    id="configText"
                    style="min-height: 100px"
                    placeholder="Nhập mô tả sách, nơi xuất bản, năm xuất bản, ..."
                  >
                  </textarea>
                  <label for="configText">
                    <i class="fas fa-pen me-2"></i>
                    Mô tả chi tiết
                  </label>
                  <div class="form-text mt-2">
                    <i class="fas fa-info-circle me-1"></i>
                    Nhập thông tin chi tiết về sách: nha xuất bản, năm xuất bản,
                    số trang, etc
                  </div>
                </div>
              </div>
            </div>
            <!-- Quản lý hình ảnh -->
            <div class="card bg-light border mb-4">
              <div class="card-header bg-transparent border-bottom">
                <h6 class="mb-0">
                  <i class="fas fa-images me-2"></i>
                  Quản lý hình ảnh sản phẩm
                </h6>
              </div>
              <div class="card-body">
                <!-- Ảnh hiện có -->
                <div class="mb-4" th:if="${product.id != null}">
                  <h6 class="fw-medium mb-3">
                    <i class="fas fa-photo-video me-2"></i>
                    Ảnh đã tải lên
                  </h6>
                  <div class="row g-3">
                    <div
                      class="col-6 col-md-4 col-lg-3"
                      th:each="i : ${#numbers.sequence(1,5)}"
                    >
                      <div class="position-relative">
                        <img
                          class="img-preview shadow-sm"
                          th:src="@{/product/{id}/image/{i}(id=${product.id}, i=${i})}"
                          th:alt="${'Ảnh ' + i}"
                          onerror="this.style.display='none'"
                        />
                        <div class="position-absolute top-0 end-0 m-2">
                          <span
                            class="badge bg-info"
                            th:if="${product.featuredIndex == i}"
                          >
                            <i class="fas fa-star me-1"></i>
                            Ảnh đại diện
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Upload ảnh mới -->
                <div>
                  <h6 class="fw-medium mb-3">
                    <i class="fas fa-upload me-2"></i>
                    Tải lên ảnh mới
                  </h6>
                  <div class="alert alert-info mb-3">
                    <div class="d-flex">
                      <div class="me-3">
                        <i class="fas fa-info-circle fa-2x"></i>
                      </div>
                      <div>
                        <h6 class="alert-heading mb-1">Hướng dẫn tải ảnh</h6>
                        <ul class="mb-0 ps-3">
                          <li>Tải lên tối đa 5 ảnh cho mỗi sản phẩm</li>
                          <li>
                            Chọn 1 ảnh làm ảnh đại diện hiển thị ngoài trang chủ
                          </li>
                          <li>Định dạng hỗ trợ: JPG, PNG, GIF</li>
                        </ul>
                      </div>
                    </div>
                  </div>

                  <div class="row g-4">
                    <!-- Ảnh 1 -->
                    <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                      <div class="card h-100">
                        <div class="card-body">
                          <div
                            class="d-flex justify-content-between align-items-center mb-3"
                          >
                            <h6 class="mb-0">Ảnh 1</h6>
                            <div class="form-check">
                              <input
                                class="form-check-input"
                                type="radio"
                                name="featuredIndex"
                                value="1"
                                th:checked="${product.featuredIndex == null ? true : (product.featuredIndex == 1)}"
                                id="featured1"
                              />
                              <label
                                class="form-check-label small"
                                for="featured1"
                              >
                                Đặt làm đại diện
                              </label>
                            </div>
                          </div>

                          <div
                            class="upload-zone p-3 bg-light rounded text-center mb-3"
                          >
                            <input
                              type="file"
                              class="form-control d-none"
                              id="imageFile1"
                              name="imageFiles"
                              accept="image/*"
                              th:attr="required=${product.id == null}"
                            />
                            <label
                              for="imageFile1"
                              class="mb-0"
                              style="cursor: pointer"
                            >
                              <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
                              <br />
                              <span class="small">Click để chọn ảnh</span>
                            </label>
                          </div>

                          <div class="preview-zone">
                            <img
                              class="img-preview shadow-sm"
                              th:if="${product.id != null}"
                              th:src="@{/product/{id}/image/1(id=${product.id})}"
                              alt="Ảnh 1"
                              onerror="this.style.display='none'"
                            />
                            <img
                              class="img-preview shadow-sm"
                              id="preview1"
                              style="display: none"
                              alt="Preview 1"
                            />
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Ảnh 2 -->
                    <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                      <div class="card h-100">
                        <div class="card-body">
                          <div
                            class="d-flex justify-content-between align-items-center mb-3"
                          >
                            <h6 class="mb-0">Ảnh 2</h6>
                            <div class="form-check">
                              <input
                                class="form-check-input"
                                type="radio"
                                name="featuredIndex"
                                value="2"
                                th:checked="${product.featuredIndex != null and product.featuredIndex == 2}"
                                id="featured2"
                              />
                              <label
                                class="form-check-label small"
                                for="featured2"
                              >
                                Đặt làm đại diện
                              </label>
                            </div>
                          </div>

                          <div
                            class="upload-zone p-3 bg-light rounded text-center mb-3"
                          >
                            <input
                              type="file"
                              class="form-control d-none"
                              id="imageFile2"
                              name="imageFiles"
                              accept="image/*"
                            />
                            <label
                              for="imageFile2"
                              class="mb-0"
                              style="cursor: pointer"
                            >
                              <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
                              <br />
                              <span class="small">Click để chọn ảnh</span>
                            </label>
                          </div>

                          <div class="preview-zone">
                            <img
                              class="img-preview shadow-sm"
                              th:if="${product.id != null}"
                              th:src="@{/product/{id}/image/2(id=${product.id})}"
                              alt="Ảnh 2"
                              onerror="this.style.display='none'"
                            />
                            <img
                              class="img-preview shadow-sm"
                              id="preview2"
                              style="display: none"
                              alt="Preview 2"
                            />
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Ảnh 3 -->
                    <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                      <div class="card h-100">
                        <div class="card-body">
                          <div
                            class="d-flex justify-content-between align-items-center mb-3"
                          >
                            <h6 class="mb-0">Ảnh 3</h6>
                            <div class="form-check">
                              <input
                                class="form-check-input"
                                type="radio"
                                name="featuredIndex"
                                value="3"
                                th:checked="${product.featuredIndex != null and product.featuredIndex == 3}"
                                id="featured3"
                              />
                              <label
                                class="form-check-label small"
                                for="featured3"
                              >
                                Đặt làm đại diện
                              </label>
                            </div>
                          </div>

                          <div
                            class="upload-zone p-3 bg-light rounded text-center mb-3"
                          >
                            <input
                              type="file"
                              class="form-control d-none"
                              id="imageFile3"
                              name="imageFiles"
                              accept="image/*"
                            />
                            <label
                              for="imageFile3"
                              class="mb-0"
                              style="cursor: pointer"
                            >
                              <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
                              <br />
                              <span class="small">Click để chọn ảnh</span>
                            </label>
                          </div>

                          <div class="preview-zone">
                            <img
                              class="img-preview shadow-sm"
                              th:if="${product.id != null}"
                              th:src="@{/product/{id}/image/3(id=${product.id})}"
                              alt="Ảnh 3"
                              onerror="this.style.display='none'"
                            />
                            <img
                              class="img-preview shadow-sm"
                              id="preview3"
                              style="display: none"
                              alt="Preview 3"
                            />
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Ảnh 4 -->
                    <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                      <div class="card h-100">
                        <div class="card-body">
                          <div
                            class="d-flex justify-content-between align-items-center mb-3"
                          >
                            <h6 class="mb-0">Ảnh 4</h6>
                            <div class="form-check">
                              <input
                                class="form-check-input"
                                type="radio"
                                name="featuredIndex"
                                value="4"
                                th:checked="${product.featuredIndex != null and product.featuredIndex == 4}"
                                id="featured4"
                              />
                              <label
                                class="form-check-label small"
                                for="featured4"
                              >
                                Đặt làm đại diện
                              </label>
                            </div>
                          </div>

                          <div
                            class="upload-zone p-3 bg-light rounded text-center mb-3"
                          >
                            <input
                              type="file"
                              class="form-control d-none"
                              id="imageFile4"
                              name="imageFiles"
                              accept="image/*"
                            />
                            <label
                              for="imageFile4"
                              class="mb-0"
                              style="cursor: pointer"
                            >
                              <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
                              <br />
                              <span class="small">Click để chọn ảnh</span>
                            </label>
                          </div>

                          <div class="preview-zone">
                            <img
                              class="img-preview shadow-sm"
                              th:if="${product.id != null}"
                              th:src="@{/product/{id}/image/4(id=${product.id})}"
                              alt="Ảnh 4"
                              onerror="this.style.display='none'"
                            />
                            <img
                              class="img-preview shadow-sm"
                              id="preview4"
                              style="display: none"
                              alt="Preview 4"
                            />
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Ảnh 5 -->
                    <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                      <div class="card h-100">
                        <div class="card-body">
                          <div
                            class="d-flex justify-content-between align-items-center mb-3"
                          >
                            <h6 class="mb-0">Ảnh 5</h6>
                            <div class="form-check">
                              <input
                                class="form-check-input"
                                type="radio"
                                name="featuredIndex"
                                value="5"
                                th:checked="${product.featuredIndex != null and product.featuredIndex == 5}"
                                id="featured5"
                              />
                              <label
                                class="form-check-label small"
                                for="featured5"
                              >
                                Đặt làm đại diện
                              </label>
                            </div>
                          </div>

                          <div
                            class="upload-zone p-3 bg-light rounded text-center mb-3"
                          >
                            <input
                              type="file"
                              class="form-control d-none"
                              id="imageFile5"
                              name="imageFiles"
                              accept="image/*"
                            />
                            <label
                              for="imageFile5"
                              class="mb-0"
                              style="cursor: pointer"
                            >
                              <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
                              <br />
                              <span class="small">Click để chọn ảnh</span>
                            </label>
                          </div>

                          <div class="preview-zone">
                            <img
                              class="img-preview shadow-sm"
                              th:if="${product.id != null}"
                              th:src="@{/product/{id}/image/5(id=${product.id})}"
                              alt="Ảnh 5"
                              onerror="this.style.display='none'"
                            />
                            <img
                              class="img-preview shadow-sm"
                              id="preview5"
                              style="display: none"
                              alt="Preview 5"
                            />
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="d-flex justify-content-between mt-4">
              <div class="d-flex gap-2">
                <button
                  type="submit"
                  name="action"
                  value="save"
                  class="btn btn-primary"
                >
                  <i class="fas fa-save me-1"></i>
                  <span th:text="${product.id == null ? 'Tạo mới' : 'Cập nhật'}"
                    >Lưu</span
                  >
                </button>
                <button
                  type="submit"
                  name="action"
                  value="save_list"
                  class="btn btn-outline-secondary"
                >
                  <i class="fas fa-list me-1"></i> Lưu &amp; về trang chủ
                </button>
              </div>
              <a
                th:href="@{/admin/dashboard}"
                class="btn btn-secondary"
                onclick="return confirm('Bạn có chắc chắc muốn hủy không?');"
              >
                <i class="fas fa-times me-1"></i>Hủy
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>

    <footer th:fragment="admin-footer">
      <div class="container text-center py-4 border-top mt-5">
        <p class="mb-1">
          &copy; <span th:text="${T(java.time.Year).now()}">2025</span> ADMIN
          MANAGER - All rights reserved.
        </p>
        <p class="text-muted small">
          Hệ thống quản trị dành cho quản lý sản phẩm, đơn hàng và người dùng.
        </p>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Preview ảnh mới chọn
      function bindPreview(inputId, previewId) {
        const input = document.getElementById(inputId);
        const preview = document.getElementById(previewId);
        if (!input || !preview) return;
        input.addEventListener("change", (e) => {
          const file = e.target.files && e.target.files[0];
          if (!file) {
            preview.style.display = "none";
            preview.src = "";
            return;
          }
          const reader = new FileReader();
          reader.onload = (ev) => {
            preview.src = ev.target.result;
            preview.style.display = "block";
          };
          reader.readAsDataURL(file);
        });
      }
      bindPreview("imageFile1", "preview1");
      bindPreview("imageFile2", "preview2");
      bindPreview("imageFile3", "preview3");
      bindPreview("imageFile4", "preview4");
      bindPreview("imageFile5", "preview5");
    </script>

    <!-- JS ghép cấu hình -->
    <script>
      (function () {
        const configField =
          document.getElementById("configuration") ||
          document.querySelector('[name="configuration"]');
        const selects = document.querySelectorAll(".cfg-select");
        const preview = document.getElementById("cfg-preview");
        const applyBtn = document.getElementById("btn-apply-cfg");
        const clearBtn = document.getElementById("btn-clear-cfg");

        function buildConfig() {
          const parts = [];
          selects.forEach((s) => {
            const val = (s.value || "").trim();
            if (!val) return;
            const label = (s.dataset.label || "").trim();
            parts.push(label ? `${val.replace(/, *$/, "")}, ${label}` : val);
          });
          return parts.join(", ");
        }

        function updatePreviewAndField() {
          const text = buildConfig();
          if (preview) preview.textContent = text;
          if (configField) configField.value = text;
        }

        selects.forEach((s) =>
          s.addEventListener("change", updatePreviewAndField)
        );

        applyBtn &&
          applyBtn.addEventListener("click", function () {
            const text = buildConfig();
            if (configField) configField.value = text;
            if (preview) preview.textContent = text;
          });

        clearBtn &&
          clearBtn.addEventListener("click", function () {
            selects.forEach((s) => (s.value = ""));
            updatePreviewAndField();
          });

        if (configField && configField.value) {
          const savedParts = configField.value
            .split(",")
            .map((p) => p.trim().toLowerCase());
          selects.forEach((s) => {
            for (let opt of s.options) {
              if (savedParts.includes(opt.text.trim().toLowerCase())) {
                s.value = opt.text;
                break;
              }
            }
          });
          updatePreviewAndField();
        } else {
          updatePreviewAndField();
        }
      })();
    </script>

    <!-- Image Management Scripts -->
    <script>
      // Initialize Dropzone for upload modal
      function initDropzone() {
        const uploadZone = document.querySelector(".upload-zone");
        const uploadInput = document.getElementById("uploadInput");

        ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
          uploadZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
          e.preventDefault();
          e.stopPropagation();
        }

        ["dragenter", "dragover"].forEach((eventName) => {
          uploadZone.addEventListener(eventName, highlight, false);
        });

        ["dragleave", "drop"].forEach((eventName) => {
          uploadZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
          uploadZone.classList.add("border", "border-primary");
        }

        function unhighlight(e) {
          uploadZone.classList.remove("border", "border-primary");
        }

        uploadZone.addEventListener("drop", handleDrop, false);

        function handleDrop(e) {
          const dt = e.dataTransfer;
          const files = dt.files;
          handleFiles(files);
        }

        uploadInput.addEventListener("change", function () {
          handleFiles(this.files);
        });
      }

      // Image preview and validation
      for (let i = 1; i <= 5; i++) {
        const imageInput = document.getElementById(`imageFile${i}`);
        const previewImage = document.getElementById(`preview${i}`);
        const uploadZone = imageInput.closest(".upload-zone");
        const previewZone = imageInput
          .closest(".card-body")
          .querySelector(".preview-zone");

        imageInput.addEventListener("change", function () {
          const file = this.files[0];
          if (file) {
            // Validate file type
            const validTypes = ["image/jpeg", "image/png", "image/gif"];
            if (!validTypes.includes(file.type)) {
              showError("Vui lòng chọn file ảnh định dạng JPG, PNG hoặc GIF");
              this.value = "";
              return;
            }

            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
              showError("Kích thước ảnh không được vượt quá 5MB");
              this.value = "";
              return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
              previewImage.src = e.target.result;
              previewImage.style.display = "block";
              uploadZone.classList.add("d-none");
              previewZone.classList.remove("d-none");

              // Add remove button
              if (!previewZone.querySelector(".remove-btn")) {
                const removeBtn = document.createElement("button");
                removeBtn.className =
                  "btn btn-sm btn-danger position-absolute top-0 end-0 m-2 remove-btn";
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                removeBtn.onclick = function (e) {
                  e.preventDefault();
                  resetImageUpload(i);
                };
                previewZone.appendChild(removeBtn);
              }
            };
            reader.readAsDataURL(file);
          }
        });
      }

      // Reset image upload
      function resetImageUpload(index) {
        const imageInput = document.getElementById(`imageFile${index}`);
        const previewImage = document.getElementById(`preview${index}`);
        const uploadZone = imageInput.closest(".upload-zone");
        const previewZone = imageInput
          .closest(".card-body")
          .querySelector(".preview-zone");

        imageInput.value = "";
        previewImage.style.display = "none";
        uploadZone.classList.remove("d-none");
        previewZone.classList.add("d-none");

        const removeBtn = previewZone.querySelector(".remove-btn");
        if (removeBtn) {
          removeBtn.remove();
        }
      }

      // Show error message using SweetAlert2
      function showError(message) {
        Swal.fire({
          icon: "error",
          title: "Lỗi",
          text: message,
          confirmButtonColor: "#3085d6",
        });
      }

      // Initialize tooltips
      const tooltipTriggerList = document.querySelectorAll(
        '[data-bs-toggle="tooltip"]'
      );
      const tooltipList = [...tooltipTriggerList].map(
        (el) => new bootstrap.Tooltip(el)
      );

      // Add custom styles
      const style = document.createElement("style");
      style.textContent = `
        .upload-zone {
          transition: all 0.3s ease;
          border: 2px dashed #dee2e6;
        }
        .upload-zone:hover {
          border-color: var(--bs-primary);
        }
        .preview-zone {
          position: relative;
        }
        .preview-zone img {
          width: 100%;
          height: auto;
          border-radius: 0.25rem;
        }
        .remove-btn {
          transition: all 0.2s ease;
          opacity: 0;
        }
        .preview-zone:hover .remove-btn {
          opacity: 1;
        }
      `;
      document.head.appendChild(style);
    </script>
  </body>
</html>
