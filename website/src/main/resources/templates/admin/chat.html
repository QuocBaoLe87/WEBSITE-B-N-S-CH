<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Quản lý Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
      :root {
        /* Theme Colors - Matching trangchu.css */
        --primary-color: #8b6f47;
        --primary-dark: #6b5535;
        --primary-light: #f5ebe0; /* Light beige for backgrounds */
        --accent-color: #d4a574;

        --success-color: #10b981;
        --danger-color: #ef4444;
        --warning-color: #f59e0b;

        --text-primary: #2b3035;
        --text-secondary: #65676b;
        --text-muted: #9b8b7e;

        --bg-light: #faf7f2;
        --bg-white: #ffffff;
        --border-color: #e5e0d8;

        --shadow-sm: 0 2px 8px rgba(139, 111, 71, 0.08);
        --shadow-md: 0 8px 16px rgba(139, 111, 71, 0.12);
        --shadow-lg: 0 12px 24px rgba(139, 111, 71, 0.15);
        --transition: all 0.3s ease;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: linear-gradient(135deg, var(--bg-light) 0%, #ffffff 100%);
        min-height: 100vh;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        color: var(--text-primary);
        /* remove extra top gap so navbar is flush with viewport top */
        padding-top: 0;
      }

      /* Force horizontal text flow site-wide inside chat to avoid vertical text */
      .chat-container,
      .chat-sidebar,
      .chat-main,
      .messages-area,
      .partners-list,
      .message-group,
      .message-bubble,
      .partner-item,
      .partner-avatar,
      .message-avatar {
        writing-mode: horizontal-tb !important;
        text-orientation: mixed !important;
      }

      .navbar {
        background: var(--primary-dark);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 0.75rem 0;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
      }

      .navbar-brand {
        font-weight: 700;
        font-size: 1.3rem;
        color: white !important;
        letter-spacing: 0.5px;
      }

      .navbar .btn-outline-light {
        border-color: rgba(255, 255, 255, 0.5);
        color: white;
        transition: var(--transition);
      }

      .navbar .btn-outline-light:hover {
        background: rgba(255, 255, 255, 0.15);
        border-color: white;
        transform: translateY(-2px);
      }

      .container-lg {
        /* keep content close under the fixed navbar */
        margin-top: 0.5rem;
      }

      .page-header {
        background: white;
        border-bottom: 3px solid var(--primary-color);
        padding: 1.5rem 2rem;
        border-radius: 1rem;
        box-shadow: var(--shadow-sm);
        margin-bottom: 2rem;
        position: relative;
      }

      .page-header h2 {
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        color: var(--primary-dark);
      }

      .page-header .subtitle {
        font-size: 0.9rem;
        color: var(--text-secondary);
      }

      .header-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
      }

      .header-actions .btn {
        background: var(--primary-light);
        border: 1px solid var(--primary-color);
        color: var(--primary-dark);
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        transition: var(--transition);
        font-weight: 500;
        cursor: pointer;
      }

      .header-actions .btn:hover {
        background: var(--primary-color);
        color: white;
        transform: translateY(-2px);
        box-shadow: var(--shadow-sm);
      }

      .chat-container {
        background: var(--bg-white);
        border-radius: 1.5rem;
        box-shadow: var(--shadow-md);
        overflow: hidden;
        display: flex;
        min-height: 75vh;
        border: 1px solid var(--border-color);
      }

      .chat-sidebar {
        width: 300px;
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        background: rgba(250, 247, 242, 0.5);
      }

      .sidebar-header {
        padding: 1.5rem;
        border-bottom: 1px solid var(--border-color);
        background: var(--bg-white);
      }

      .sidebar-header h5 {
        margin: 0;
        font-weight: 600;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-primary);
      }

      .sidebar-header .icon {
        font-size: 1.3rem;
        color: var(--primary-color);
      }

      .search-box {
        padding: 0;
        margin: 1rem;
        margin-bottom: 0;
      }

      .search-box input {
        border: 1px solid var(--border-color);
        border-radius: 2rem;
        padding: 0.75rem 1rem;
        font-size: 0.95rem;
        background: var(--bg-white);
        transition: var(--transition);
        width: 100%;
      }

      .search-box input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(139, 111, 71, 0.1);
        outline: none;
      }

      .partners-list {
        flex: 1;
        overflow-y: auto;
        padding: 0.5rem;
      }

      .partners-list::-webkit-scrollbar {
        width: 6px;
      }

      .partners-list::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 3px;
      }

      .partner-item {
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        border-radius: 0.75rem;
        cursor: pointer;
        transition: var(--transition);
        border: 1px solid transparent;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        background: var(--bg-white);
      }

      .partner-item:hover {
        background: var(--primary-light);
        border-color: var(--primary-color);
        transform: translateX(4px);
      }

      .partner-item.active {
        background: var(--primary-light);
        border-color: var(--primary-color);
        font-weight: 600;
        color: var(--primary-color);
      }

      .partner-avatar {
        width: 40px;
        height: 40px;
        min-width: 40px;
        min-height: 40px;
        border-radius: 50%;
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--primary-dark)
        );
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 0.95rem;
        flex-shrink: 0;
        white-space: nowrap;
        text-align: center;
        line-height: 1;
        overflow: hidden;
        /* enforce fixed avatar size to avoid stretching when message bubbles are tall */
        width: 40px !important;
        height: 40px !important;
        min-width: 40px !important;
        min-height: 40px !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
        writing-mode: horizontal-tb !important;
        text-orientation: mixed !important;
      }

      .partner-info {
        flex: 1;
        min-width: 0;
      }

      .partner-name {
        font-weight: 600;
        font-size: 0.95rem;
        color: var(--text-primary);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .partner-preview {
        font-size: 0.85rem;
        color: var(--text-muted);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: var(--bg-white);
      }

      .chat-header {
        padding: 1.5rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(4px);
      }

      .chat-header-left {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .chat-header-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--primary-dark)
        );
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 1.2rem;
      }

      .chat-header-info h6 {
        margin: 0;
        font-weight: 600;
        color: var(--text-primary);
      }

      .chat-header-info .status {
        font-size: 0.85rem;
        color: var(--text-muted);
      }

      .chat-header-actions {
        display: flex;
        gap: 0.5rem;
      }

      .chat-header-actions .btn {
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        border: none;
        background: var(--bg-light);
        color: var(--text-secondary);
        cursor: pointer;
        transition: var(--transition);
        font-size: 0.9rem;
      }

      .chat-header-actions .btn:hover {
        background: var(--primary-light);
        color: var(--primary-color);
      }

      .messages-area {
        /* Limit messages area height to roughly 2/3 of the chat container (approx 50vh)
           so the dialog doesn't become too long; keep internal scroll */
        flex: 1;
        overflow-y: auto;
        max-height: 50vh;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .messages-area::-webkit-scrollbar {
        width: 6px;
      }

      .messages-area::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 3px;
      }

      .message-group {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 0.5rem;
        /* center avatars vertically with the bubble */
        align-items: center;
      }

      .message-group.sent {
        justify-content: flex-end;
      }

      .message-avatar {
        width: 32px;
        height: 32px;
        min-width: 32px;
        min-height: 32px;
        border-radius: 50%;
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--primary-dark)
        );
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 0.85rem;
        flex-shrink: 0;
        white-space: nowrap;
        text-align: center;
        line-height: 1;
        overflow: hidden;
        width: 32px !important;
        height: 32px !important;
        min-width: 32px !important;
        min-height: 32px !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
        writing-mode: horizontal-tb !important;
        text-orientation: mixed !important;
      }

      /* Prevent avatars from stretching vertically and keep them centered */
      .partner-avatar,
      .message-avatar {
        flex: 0 0 auto !important;
        align-self: center !important;
        box-sizing: border-box !important;
        overflow: hidden !important;
        width: 40px !important;
        height: 40px !important;
        max-height: 40px !important;
        min-width: 40px !important;
        min-height: 40px !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
        border-radius: 50% !important;
      }

      /* Stronger rules to override other CSS (use very specific selectors and !important)
         This forces avatars to be circular and prevents vertical stretching. */
      .chat-container .partner-avatar,
      .chat-container .message-avatar,
      .partners-list .partner-avatar,
      .messages-area .message-avatar,
      .partner-item .partner-avatar,
      .message-group .message-avatar {
        width: 40px !important;
        height: 40px !important;
        max-width: 40px !important;
        max-height: 40px !important;
        min-width: 40px !important;
        min-height: 40px !important;
        box-sizing: border-box !important;
        overflow: hidden !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
        flex: 0 0 auto !important;
        border-radius: 50% !important;
        line-height: 1 !important;
        font-size: 0.9rem !important;
        text-align: center !important;
        writing-mode: horizontal-tb !important;
      }

      /* Keep partner list items vertically centered */
      .partner-item {
        align-items: center;
      }

      /* Prevent flex children from stretching avatars */
      .message-group,
      .message-group > div,
      .message-group > .message-avatar {
        align-items: flex-end;
      }

      .message-group.sent .message-avatar {
        order: 2;
        background: rgba(139, 111, 71, 0.15);
        color: var(--primary-color);
      }

      .message-bubble {
        /* Make bubbles more compact and avoid breaking individual letters */
        display: inline-block;
        max-width: 45%;
        padding: 0.5rem 0.75rem;
        border-radius: 1rem;
        /* Prefer breaking at word boundaries and preserve spaces/newlines */
        overflow-wrap: break-word;
        word-break: normal;
        white-space: pre-wrap;
        writing-mode: horizontal-tb !important;
        line-height: 1.3;
        font-size: 0.9rem;
        animation: slideIn 0.25s ease;
      }

      /* Sent messages: when there is no avatar element, force the bubble to align right
         and avoid flex layout stretching. This prevents a column of tall pills on the right. */
      .message-group.sent > div {
        margin-left: auto;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
      }

      /* Ensure bubble stays compact for short content */
      .message-bubble.received,
      .message-bubble.sent {
        display: inline-block;
        vertical-align: middle;
        max-width: 45%;
        padding: 0.45rem 0.7rem !important;
        line-height: 1.2 !important;
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message-bubble.received {
        background: var(--bg-light);
        color: var(--text-primary);
        border-bottom-left-radius: 0.25rem;
      }

      .message-bubble.sent {
        background: var(--primary-color);
        color: white;
        border-bottom-right-radius: 0.25rem;
      }

      .message-time {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-top: 0.25rem;
        text-align: center;
      }

      .empty-state {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: var(--text-muted);
        flex-direction: column;
        gap: 1rem;
      }

      .empty-state i {
        font-size: 3rem;
        opacity: 0.3;
      }

      .chat-input-area {
        padding: 1.5rem;
        border-top: 1px solid var(--border-color);
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(4px);
      }

      .chat-form {
        display: flex;
        gap: 0.75rem;
      }

      .chat-input {
        flex: 1;
        border: 1px solid var(--border-color);
        border-radius: 2rem;
        padding: 0.75rem 1.25rem;
        font-size: 0.95rem;
        background: var(--bg-white);
        transition: var(--transition);
        color: var(--text-primary);
      }

      .chat-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(139, 111, 71, 0.1);
        outline: none;
      }

      .chat-input::placeholder {
        color: var(--text-muted);
      }

      .btn-primary {
        background: var(--primary-color);
        border: none;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 2rem;
        cursor: pointer;
        transition: var(--transition);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .btn-primary:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(139, 111, 71, 0.3);
      }

      .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        background: var(--success-color);
        border-radius: 50%;
        margin-right: 0.5rem;
      }

      .status-indicator.offline {
        background: var(--text-muted);
      }

      @media (max-width: 768px) {
        .chat-sidebar {
          width: 100%;
          min-height: 40vh;
          border-right: none;
          border-bottom: 1px solid var(--border-color);
        }

        .chat-container {
          flex-direction: column;
          min-height: auto;
        }

        .message-bubble {
          max-width: 80%;
        }

        .page-header {
          padding: 1.5rem;
        }

        .page-header h2 {
          font-size: 1.5rem;
        }
      }
    </style>
  </head>

  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container-lg">
        <a class="navbar-brand" th:href="@{/admin/dashboard}">
          <i class="fas fa-comments me-2"></i> CHAT ADMIN
        </a>
        <div class="ms-auto d-flex gap-2">
          <a
            class="btn btn-outline-light btn-sm"
            th:href="@{/admin/dashboard}"
            title="Dashboard"
          >
            <i class="fas fa-home"></i>
          </a>
          <form th:action="@{/logout}" method="post" class="d-inline">
            <input
              type="hidden"
              th:name="${_csrf.parameterName}"
              th:value="${_csrf.token}"
            />
            <button
              type="submit"
              class="btn btn-outline-light btn-sm"
              title="Đăng xuất"
            >
              <i class="fas fa-sign-out-alt"></i>
            </button>
          </form>
        </div>
      </div>
    </nav>

    <!-- Main Container -->
    <div class="container-lg">
      <!-- Header -->
      <div class="page-header">
        <div>
          <h2><i class="fas fa-comments me-2"></i> Quản lý Chat</h2>
          <p class="subtitle mb-0">
            <i class="fas fa-info-circle me-1"></i>
            Giao tiếp trực tiếp với khách hàng
          </p>
        </div>
        <div class="header-actions">
          <button class="btn" id="btnRefresh" title="Làm mới">
            <i class="fas fa-sync-alt me-1"></i> Làm mới
          </button>
        </div>
      </div>

      <!-- Chat Container -->
      <div class="chat-container">
        <!-- Sidebar -->
        <div class="chat-sidebar">
          <div class="sidebar-header">
            <h5><i class="fas fa-users icon"></i> Cuộc trò chuyện</h5>
          </div>

          <div class="search-box">
            <input
              type="text"
              id="partnerSearch"
              placeholder="Tìm khách hàng..."
              autocomplete="off"
            />
          </div>

          <div class="partners-list" id="partnersList">
            <div class="empty-state">
              <i class="fas fa-inbox"></i>
              <small>Không có cuộc trò chuyện nào</small>
            </div>
          </div>
        </div>

        <!-- Main Chat Area -->
        <div class="chat-main">
          <!-- Chat Header -->
          <div class="chat-header" id="chatHeader">
            <div class="chat-header-left">
              <div class="chat-header-avatar" id="currentPartnerAvatar">-</div>
              <div class="chat-header-info">
                <h6 id="currentPartnerName">Chọn cuộc trò chuyện</h6>
                <div class="status">
                  <span class="status-indicator offline"></span>
                  <span id="currentPartnerStatus">Chưa kết nối</span>
                </div>
              </div>
            </div>
            <div class="chat-header-actions">
              <button
                class="btn"
                id="btnDelete"
                title="Xóa cuộc trò chuyện"
                style="display: none"
              >
                <i class="fas fa-trash-alt"></i> Xóa
              </button>
            </div>
          </div>

          <!-- Messages -->
          <div class="messages-area" id="messagesArea">
            <div class="empty-state">
              <i class="fas fa-message"></i>
              <p>Chọn một khách hàng để bắt đầu trò chuyện</p>
            </div>
          </div>

          <!-- Input -->
          <div class="chat-input-area" id="inputArea" style="display: none">
            <form class="chat-form" id="chatForm">
              <input
                type="text"
                class="chat-input"
                id="chatInput"
                placeholder="Nhập tin nhắn..."
                autocomplete="off"
              />
              <button type="submit" class="btn-primary">
                <i class="fas fa-paper-plane"></i> Gửi
              </button>
            </form>
          </div>

          <div class="empty-state" id="emptyInputArea">
            <i class="fas fa-comments"></i>
            <p>Chọn khách hàng để nhập tin nhắn</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <script th:inline="javascript">
      const myUsername = /*[[${username}?:'ADMIN']]*/ "ADMIN";
      const csrfToken = document
        .querySelector('meta[name="_csrf"]')
        .getAttribute("content");
      const csrfHeader = document
        .querySelector('meta[name="_csrf_header"]')
        .getAttribute("content");

      let stompClient = null;
      let currentPartner = null;
      let partners = [];
      let messages = {};

      function connect() {
        const socket = new SockJS("/ws-chat");
        stompClient = Stomp.over(socket);
        stompClient.connect({}, () => {
          console.log("WebSocket connected");
          subscribeToMessages();
          loadPartners();
        });
      }

      function subscribeToMessages() {
        stompClient.subscribe("/user/queue/messages", (message) => {
          const data = JSON.parse(message.body);
          displayMessage(data);
        });
      }

      function loadPartners() {
        fetch("/api/chat/partners")
          .then((r) => {
            if (!r.ok)
              return r.text().then((t) => {
                throw new Error(`${r.status} ${t}`);
              });
            return r.json();
          })
          .then((data) => {
            partners = data;
            renderPartners();
          })
          .catch((e) => console.error("Error loading partners:", e));
      }

      function renderPartners() {
        const list = document.getElementById("partnersList");
        if (partners.length === 0) {
          list.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-inbox"></i>
              <small>Không có cuộc trò chuyện nào</small>
            </div>
          `;
          return;
        }

        list.innerHTML = partners
          .map(
            (p) => `
          <div class="partner-item ${
            currentPartner === p.username ? "active" : ""
          }" 
               onclick="selectPartner('${p.username}')">
            <div class="partner-avatar">${p.username
              .charAt(0)
              .toUpperCase()}</div>
            <div class="partner-info">
              <div class="partner-name">${p.username}</div>
              <div class="partner-preview">${
                p.lastMessage || "Không có tin nhắn"
              }</div>
            </div>
          </div>
        `
          )
          .join("");
      }

      function selectPartner(username) {
        currentPartner = username;
        document.getElementById("currentPartnerName").textContent = username;
        document.getElementById("currentPartnerAvatar").textContent = username
          .charAt(0)
          .toUpperCase();
        document.getElementById("currentPartnerStatus").textContent =
          "Đang kết nối...";
        document.getElementById("btnDelete").style.display = "inline-block";
        document.getElementById("inputArea").style.display = "block";
        document.getElementById("emptyInputArea").style.display = "none";

        renderPartners();
        loadMessages(username);
      }

      function loadMessages(username) {
        fetch(`/api/chat/history?with=${username}`)
          .then((r) => r.json())
          .then((data) => {
            messages[username] = data;
            renderMessages();
          })
          .catch((e) => console.error("Error loading messages:", e));
      }

      function renderMessages() {
        const area = document.getElementById("messagesArea");
        const msgs = messages[currentPartner] || [];

        if (msgs.length === 0) {
          area.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-comments"></i>
              <p>Chưa có tin nhắn nào</p>
            </div>
          `;
          return;
        }

        area.innerHTML = msgs
          .map(
            (msg) => `
          <div class="message-group ${msg.from === myUsername ? "sent" : ""}">
            ${
              msg.from !== myUsername
                ? `<div class="message-avatar">${msg.from
                    .charAt(0)
                    .toUpperCase()}</div>`
                : ""
            }
            <div>
              <div class="message-bubble ${
                msg.from === myUsername ? "sent" : "received"
              }">
                ${escapeHtml(msg.content)}
              </div>
              <div class="message-time">${formatTime(msg.sentAt)}</div>
            </div>
          </div>
        `
          )
          .join("");

        area.scrollTop = area.scrollHeight;
      }

      function displayMessage(data) {
        // Xác định đúng partner (người còn lại trong cuộc hội thoại)
        const partner = data.from === myUsername ? data.to : data.from;

        if (!messages[partner]) messages[partner] = [];
        messages[partner].push(data);

        // Cập nhật nếu đang chat với partner này
        if (currentPartner === partner) {
          renderMessages();
        }

        // Cập nhật partners list
        loadPartners();
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function formatTime(dateStr) {
        if (!dateStr) return "";
        const date = new Date(dateStr);
        return date.toLocaleTimeString("vi-VN", {
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      document.getElementById("chatForm").addEventListener("submit", (e) => {
        e.preventDefault();
        const input = document.getElementById("chatInput");
        const content = input.value.trim();
        if (!content || !currentPartner) return;

        if (stompClient && stompClient.connected) {
          const msg = {
            to: currentPartner,
            content: content,
          };

          stompClient.send("/app/chat.send", {}, JSON.stringify(msg));

          // Hiển thị tin nhắn ngay lập tức (optimistic update)
          displayMessage({
            from: myUsername,
            to: currentPartner,
            content: content,
            sentAt: new Date().toISOString(),
          });
        }

        input.value = "";
      });

      document.getElementById("btnDelete").addEventListener("click", () => {
        if (!confirm(`Xóa cuộc trò chuyện với ${currentPartner}?`)) return;

        fetch("/api/chat/delete-conversation", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            [csrfHeader]: csrfToken,
          },
          body: JSON.stringify({ username: currentPartner }),
        })
          .then((r) => (r.ok ? r.json() : Promise.reject(r)))
          .then(() => {
            currentPartner = null;
            messages = {};
            loadPartners();
            document.getElementById("messagesArea").innerHTML = `
            <div class="empty-state">
              <i class="fas fa-comments"></i>
              <p>Chọn một khách hàng để bắt đầu trò chuyện</p>
            </div>
          `;
            document.getElementById("inputArea").style.display = "none";
            document.getElementById("emptyInputArea").style.display = "flex";
          })
          .catch((e) => alert("Lỗi: " + (e.statusText || "Không thể xóa")));
      });

      document
        .getElementById("partnerSearch")
        .addEventListener("input", (e) => {
          const query = e.target.value.toLowerCase();
          const items = document.querySelectorAll(".partner-item");
          items.forEach((item) => {
            const name = item
              .querySelector(".partner-name")
              .textContent.toLowerCase();
            item.style.display = name.includes(query) ? "" : "none";
          });
        });

      document.getElementById("btnRefresh").addEventListener("click", () => {
        loadPartners();
        if (currentPartner) loadMessages(currentPartner);
      });

      connect();
    </script>
  </body>
</html>
