<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
>
  <head>
    <meta charset="UTF-8" />
    <title th:text="|${book.name} — ZUNO Library|">Chi tiết Sách</title>

    <!-- Bootstrap + Icons -->
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <link rel="stylesheet" th:href="@{/css/trangchu.css}" />

    <style>
      /* Carousel styling */
      #bookCarousel {
        --bs-carousel-control-prev-icon-bg: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Cpath fill='%238b4513' d='M11.354 1.646a.5.5 0 0 1 0 .708L6.707 7l4.647 4.646a.5.5 0 0 1-.708.708l-5-5a.5.5 0 0 1 0-.708l5-5a.5.5 0 0 1 .708 0z'/%3E%3C/svg%3E");
        --bs-carousel-control-next-icon-bg: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Cpath fill='%238b4513' d='M4.646 1.646a.5.5 0 0 1 .708 0l5 5a.5.5 0 0 1 0 .708l-5 5a.5.5 0 0 1-.708-.708L9.293 7 4.646 2.354a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
      }
      #bookCarousel .carousel-control-prev-icon,
      #bookCarousel .carousel-control-next-icon {
        filter: none;
        background-size: 100% 100%;
        width: 2rem;
        height: 2rem;
      }
      #bookCarousel .carousel-control-prev,
      #bookCarousel .carousel-control-next {
        width: 4rem;
        height: 4rem;
      }

      .carousel .rounded-img {
        max-height: 420px;
        object-fit: contain;
        border-radius: 1rem;
      }
      .card-soft {
        border-radius: 1rem;
      }
      .shadow-smooth {
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.06);
      }

      .rating-stars {
        display: flex;
        gap: 0.35rem;
        font-size: 1.6rem;
        cursor: pointer;
        user-select: none;
      }
      .rating-stars .star {
        transition: transform 0.1s ease;
      }
      .rating-stars .star:hover {
        transform: translateY(-2px) scale(1.05);
      }
      .star.inactive {
        color: #ced4da;
      }
      .star.active {
        color: #ffc107;
      }

      .review-item {
        border-bottom: 1px dashed #e9ecef;
        padding-bottom: 0.75rem;
        margin-bottom: 1rem;
      }
      .review-item:last-child {
        border: 0;
        margin: 0;
        padding: 0;
      }
      .badge-avg {
        font-size: 1.05rem;
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <div class="container" style="margin-top: 100px">
      <div class="container py-4">
        <div class="row g-4">
          <!-- Carousel -->
          <div class="col-md-6">
            <div
              id="bookCarousel"
              class="carousel slide shadow-smooth card-soft"
              data-bs-ride="carousel"
            >
              <div
                class="carousel-indicators"
                th:if="${!#lists.isEmpty(book.images)}"
              >
                <button
                  type="button"
                  th:each="image, stat : ${book.images}"
                  th:attr="data-bs-target='#bookCarousel',data-bs-slide-to=${stat.index}"
                  th:classappend="${stat.index == 0} ? ' active'"
                ></button>
              </div>
              <div class="carousel-inner">
                <div
                  th:if="${!#lists.isEmpty(book.images)}"
                  th:each="image, stat : ${book.images}"
                  th:class="'carousel-item' + (${stat.index == 0} ? ' active' : '')"
                >
                  <img
                    th:src="@{${image.url}}"
                    class="d-block w-100 rounded-img"
                    th:alt="|${book.name} ảnh ${stat.index+1}|"
                  />
                </div>
                <div
                  th:if="${#lists.isEmpty(book.images)}"
                  class="carousel-item active"
                >
                  <img
                    th:src="@{${book.imageUrl}}"
                    class="d-block w-100 rounded-img"
                    th:alt="${book.name}"
                  />
                </div>
              </div>
              <button
                class="carousel-control-prev"
                type="button"
                data-bs-target="#bookCarousel"
                data-bs-slide="prev"
              >
                <span class="carousel-control-prev-icon"></span>
                <span class="visually-hidden">Trước</span>
              </button>
              <button
                class="carousel-control-next"
                type="button"
                data-bs-target="#bookCarousel"
                data-bs-slide="next"
              >
                <span class="carousel-control-next-icon"></span>
                <span class="visually-hidden">Sau</span>
              </button>
            </div>
          </div>

          <!-- Info + add-to-cart -->
          <div class="col-md-6">
            <div class="card card-soft shadow-smooth h-100">
              <div class="card-body">
                <h2 class="mb-1" th:text="${book.name}">Tên Sách</h2>
                <p class="text-muted" th:text="${book.brand}">Nhà xuất bản</p>
                <h3
                  class="text-primary fw-bold"
                  th:text="|${#numbers.formatDecimal(book.price,1,0)} ₫|"
                >
                  Giá
                </h3>

                <hr />
                <h6 class="text-uppercase text-secondary mb-2">chi tiết</h6>
                <p th:text="${book.configuration}">Chi tiết sách...</p>

                <form
                  th:action="@{/cart/add/{id}(id=${book.id})}"
                  method="post"
                >
                  <input
                    type="hidden"
                    th:name="${_csrf.parameterName}"
                    th:value="${_csrf.token}"
                  />
                  <button type="submit" class="btn btn-primary">
                    <i class="bi bi-cart-plus"></i> Thêm vào giỏ hàng
                  </button>
                </form>

                <a
                  href="javascript:history.back()"
                  class="btn btn-outline-secondary ms-2"
                  >← Quay về</a
                >
              </div>
            </div>
          </div>
        </div>

        <!-- Reviews -->
        <div class="row g-4 mt-1">
          <div class="col-lg-7">
            <div class="card card-soft shadow-smooth">
              <div class="card-body">
                <div
                  class="d-flex align-items-center justify-content-between mb-3"
                >
                  <h4 class="mb-0">Đánh giá</h4>
                  <span class="badge text-bg-warning badge-avg">
                    ★
                    <span
                      id="avgRating"
                      th:text="${#numbers.formatDecimal(avgRating,1,1)}"
                      >0.0</span
                    >
                    / 5
                  </span>
                </div>

                <div id="reviews" th:attr="data-book-id=${book.id}">
                  <div th:if="${#lists.isEmpty(reviews)}" class="text-muted">
                    Chưa có đánh giá nào.
                  </div>
                  <div th:each="r : ${reviews}" class="review-item">
                    <div
                      th:replace="~{fragments/review-item :: item(r=${r})}"
                    ></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-5">
            <div class="card card-soft shadow-smooth">
              <div class="card-body">
                <h5 class="card-title mb-3">Viết đánh giá</h5>

                <div sec:authorize="isAuthenticated()">
                  <form
                    id="reviewForm"
                    th:action="@{/product/{id}/review(id=${book.id})}"
                    method="post"
                  >
                    <input
                      type="hidden"
                      th:name="${_csrf.parameterName}"
                      th:value="${_csrf.token}"
                    />
                    <input type="hidden" id="rating" name="rating" value="5" />
                    <div
                      class="rating-stars mb-3"
                      id="stars"
                      aria-label="Chọn số sao"
                    >
                      <span class="star active">★</span>
                      <span class="star active">★</span>
                      <span class="star active">★</span>
                      <span class="star active">★</span>
                      <span class="star active">★</span>
                    </div>

                    <div class="mb-3">
                      <label for="comment" class="form-label">Bình luận</label>
                      <textarea
                        name="comment"
                        id="comment"
                        class="form-control"
                        rows="3"
                        placeholder="Chia sẻ trải nghiệm của bạn..."
                      ></textarea>
                    </div>
                    <button
                      type="submit"
                      id="btnSend"
                      class="btn btn-success w-100"
                    >
                      Gửi đánh giá
                    </button>
                  </form>
                </div>

                <div class="form-text mt-2" sec:authorize="isAnonymous()">
                  Bạn phải <a th:href="@{/login}">đăng nhập</a> để gửi đánh giá.
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-4" th:replace="~{fragments/footer :: footer}"></div>
      </div>
    </div>

    <script th:src="@{/js/bootstrap.bundle.min.js}"></script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const stars = document.querySelectorAll("#stars .star");
        const ratingInput = document.getElementById("rating");
        function paint(n) {
          stars.forEach(
            (s, i) => (s.className = "star " + (i < n ? "active" : "inactive"))
          );
        }
        stars.forEach((el, idx) => {
          el.addEventListener("mouseenter", () => paint(idx + 1));
          el.addEventListener("mouseleave", () =>
            paint(+ratingInput?.value || 5)
          );
          el.addEventListener("click", () => {
            if (ratingInput) {
              ratingInput.value = String(idx + 1);
              paint(idx + 1);
            }
          });
        });
        if (ratingInput) paint(+ratingInput.value || 5);

        const form = document.getElementById("reviewForm");
        const btn = document.getElementById("btnSend");
        form?.addEventListener("submit", async function (e) {
          e.preventDefault();
          const action = form.getAttribute("action");
          const formData = new FormData(form);

          btn.disabled = true;
          const oldTxt = btn.innerText;
          btn.innerText = "Đang gửi...";
          try {
            const resp = await fetch(action, {
              method: "POST",
              headers: { "X-Requested-With": "XMLHttpRequest" },
              body: formData,
            });
            if (!resp.ok) {
              if (resp.status === 401) {
                window.location.href = "/login";
                return;
              }
              throw new Error("HTTP " + resp.status);
            }
            const html = await resp.text();

            const container = document.getElementById("reviews");
            const wrap = document.createElement("div");
            wrap.className = "review-item";
            wrap.innerHTML = html.trim();
            const empty = container.querySelector(".text-muted");
            if (empty) empty.remove();
            container.prepend(wrap);

            const bookId = container?.dataset.bookId;
            if (bookId) {
              const avgResp = await fetch(`/product/${bookId}/avg`);
              if (avgResp.ok) {
                const txt = await avgResp.text();
                document.getElementById("avgRating").textContent = txt;
              }
            }

            form.reset();
            if (ratingInput) {
              ratingInput.value = "5";
              paint(5);
            }
          } catch (err) {
            alert("Gửi đánh giá thất bại. Vui lòng thử lại!");
            console.error(err);
          } finally {
            btn.disabled = false;
            btn.innerText = oldTxt;
          }
        });
      });
    </script>
  </body>
</html>
